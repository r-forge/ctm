
R version 3.2.1 (2015-06-18) -- "World-Famous Astronaut"
Copyright (C) 2015 The R Foundation for Statistical Computing
Platform: x86_64-unknown-linux-gnu (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> 
> library("mlt")
Loading required package: basefun
> set.seed(29)
> 
> n <- 20
> ### design has rank deficit; just for interface checking
> ### we need something better!
> d <- data.frame(x1 = 1:n, x2 = 1:n + 1, y = rnorm(n))
> m <- model(polynomial_basis(c(TRUE, TRUE), varname = "y",
+            ci = c(-Inf, 0), support = range(d$y)),
+            shift = ~ x1 + x2)
> mod <- mlt(m, data = d)
Gradient[1] "Mean relative difference: 2.506007e-05"
Hessian:[1] TRUE
> 
> p <- tmlt(mod, newdata = d)
> 
> system.time(p0 <- predict(mod$model$model, 
+     newdata = expand.grid(d), coef = coef(mod)))
   user  system elapsed 
  0.011   0.000   0.011 
> system.time(p1 <- tmlt(mod, newdata = as.list(d)))
   user  system elapsed 
  0.005   0.000   0.005 
> system.time(p2 <- tmlt(mod, newdata = d, q = d$y[1]))
   user  system elapsed 
  0.004   0.000   0.004 
> 
> max(abs(p0 - as.vector(p1)))
[1] 0
> 
> all.equal(p1[cbind(1:n, 1:n, 1), drop = TRUE],
+           drop(p2))
[1] TRUE
> 
> all.equal(p1[cbind(1:n, 1:n, 1:n), drop = TRUE],
+           drop(p), check.attributes = FALSE)
[1] TRUE
> 
> qmlt(mod, newdata = list(x1 = 1:3, x2 = 2:3), p = c(.25, .5))
, , x2 =     2

       x1
p                1          2            3
   0.25 -0.8374046 -0.7601555 -0.682891574
    0.5 -0.1534061 -0.0761265  0.001154162

, , x2 =     3

       x1
p                1          2           3
   0.25 -0.8885554 -0.8112379 -0.73390440
    0.5 -0.2045293 -0.1272481 -0.04996819

> 
> simulate(mod, nsim = 1, seed = 291, interpolate = FALSE)
           left       right
1          -Inf -1.44201141
2   0.587961900  0.66046095
3  -1.297013314 -1.22451427
4   0.805459040  0.87795809
5   0.297965713  0.37046476
6   0.370464760  0.44296381
7   2.110441880         Inf
8   1.312952366  1.38545141
9  -0.137028567 -0.06452952
10  1.167954273  1.24045332
11 -1.369512361 -1.29701331
12  0.007969526  0.08046857
13  0.732959993  0.80545904
14  0.297965713  0.37046476
15  0.805459040  0.87795809
16  1.022956180  1.09545523
17 -1.224514267 -1.15201522
18  0.515462853  0.58796190
19  0.370464760  0.44296381
20  1.892944740  1.96544379
> 
> d$y <- gl(3, 1, ordered = TRUE)[rep(1:3, length = n)]
> 
> r <- as.basis(~ y, data = d, remove_intercept = TRUE,
+               contrasts.arg = list(y = function(n)
+                   contr.treatment(n, base = 3)),
+               ui = diff(diag(2)), ci = 0)
> 
> mod2 <- mlt(model(r, shift = ~ x1 + x2), data = d)
Gradient[1] "Mean relative difference: 6.304043e-06"
Hessian:[1] TRUE
Warning messages:
1: In .log(.dealinf(mmr, beta, offset, d$p, 1) - .dealinf(mml, beta,  :
  negative contribution to likelihood; constraints violated!
2: In .log(.dealinf(mmr, beta, offset, d$p, 1) - .dealinf(mml, beta,  :
  negative contribution to likelihood; constraints violated!
3: In .log(.dealinf(mmr, beta, offset, d$p, 1) - .dealinf(mml, beta,  :
  negative contribution to likelihood; constraints violated!
> 
> tmlt(mod2, q = unique(d$y))
   
y         [,1]       [,2]       [,3]       [,4]       [,5]       [,6]
  1 -0.3152734 -0.3226474 -0.3300213 -0.3373952 -0.3447691 -0.3521430
  2  0.5952517  0.5878778  0.5805038  0.5731299  0.5657560  0.5583821
  3        Inf        Inf        Inf        Inf        Inf        Inf
   
y         [,7]       [,8]       [,9]      [,10]      [,11]      [,12]
  1 -0.3595170 -0.3668909 -0.3742648 -0.3816387 -0.3890127 -0.3963866
  2  0.5510082  0.5436342  0.5362603  0.5288864  0.5215125  0.5141386
  3        Inf        Inf        Inf        Inf        Inf        Inf
   
y        [,13]      [,14]      [,15]      [,16]      [,17]      [,18]
  1 -0.4037605 -0.4111344 -0.4185083 -0.4258823 -0.4332562 -0.4406301
  2  0.5067646  0.4993907  0.4920168  0.4846429  0.4772689  0.4698950
  3        Inf        Inf        Inf        Inf        Inf        Inf
   
y        [,19]      [,20]
  1 -0.4480040 -0.4553779
  2  0.4625211  0.4551472
  3        Inf        Inf
> 
> qmlt(mod2, p = 1:9 / 10)
  [1] 1 1 1 2 2 2 2 3 3 1 1 1 2 2 2 2 3 3 1 1 1 2 2 2 2 3 3 1 1 1 2 2 2 2 3 3 1
 [38] 1 1 2 2 2 2 3 3 1 1 1 2 2 2 2 3 3 1 1 1 2 2 2 2 3 3 1 1 1 2 2 2 2 3 3 1 1
 [75] 1 2 2 2 2 3 3 1 1 1 2 2 2 2 3 3 1 1 1 2 2 2 3 3 3 1 1 1 2 2 2 3 3 3 1 1 1
[112] 2 2 2 3 3 3 1 1 1 2 2 2 3 3 3 1 1 1 2 2 2 3 3 3 1 1 1 2 2 2 3 3 3 1 1 1 2
[149] 2 2 3 3 3 1 1 1 2 2 2 3 3 3 1 1 1 2 2 2 3 3 3 1 1 1 2 2 2 3 3 3
Levels: 1 < 2 < 3
> 
> simulate(mod2, nsim = 3, seed = 29)
[[1]]
 [1] 1 1 1 1 2 1 3 3 1 1 3 2 1 2 1 3 2 2 3 2
Levels: 1 < 2 < 3

[[2]]
 [1] 2 2 3 3 2 1 2 3 2 1 2 1 1 3 2 1 3 1 2 1
Levels: 1 < 2 < 3

[[3]]
 [1] 2 1 3 2 1 3 3 3 2 2 2 3 1 2 2 2 2 3 2 1
Levels: 1 < 2 < 3

> 
> dmlt(mod2, q = unique(d$y))
          [,1]      [,2]      [,3]      [,4]      [,5]      [,6]      [,7]
[1,] 0.3762770 0.3734812 0.3706919 0.3679095 0.3651340 0.3623655 0.3596042
[2,] 0.3478854 0.3482117 0.3485206 0.3488121 0.3490862 0.3493428 0.3495818
[3,] 0.2758376 0.2783072 0.2807874 0.2832784 0.2857798 0.2882918 0.2908140
          [,8]      [,9]     [,10]     [,11]     [,12]     [,13]     [,14]
[1,] 0.3568502 0.3541037 0.3513647 0.3486334 0.3459099 0.3431944 0.3404870
[2,] 0.3498032 0.3500070 0.3501932 0.3503617 0.3505125 0.3506456 0.3507609
[3,] 0.2933466 0.2958893 0.2984421 0.3010049 0.3035776 0.3061600 0.3087521
         [,15]     [,16]     [,17]     [,18]     [,19]     [,20]
[1,] 0.3377877 0.3350968 0.3324143 0.3297404 0.3270751 0.3244187
[2,] 0.3508585 0.3509383 0.3510004 0.3510446 0.3510710 0.3510796
[3,] 0.3113537 0.3139648 0.3165853 0.3192150 0.3218538 0.3245017
> 
> dmlt(mod2, list(y = unique(d$y), x1 = 1:3, x2 = 2:3))
, ,     2

          1         2         3
1 0.3762770 0.3466112 0.3178576
2 0.3478854 0.3504753 0.3510240
3 0.2758376 0.3029135 0.3311184

, ,     3

          1         2         3
1 0.4038342 0.3734812 0.3438936
2 0.3438085 0.3482117 0.3506130
3 0.2523573 0.2783072 0.3054934

> 
> 
> proc.time()
   user  system elapsed 
  1.512   0.040   1.543 
