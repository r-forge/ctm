
> pkgs <- c("mlt", "tram", "trtf", "SparseGrid", "ATR", 
+     "tramME", "multcomp", "coin", "TH.data", "survival", "colorspace", 
+     "xtable", "en ..." ... [TRUNCATED] 

> pkgs <- sapply(pkgs, require, character.only = TRUE)
Loading required package: mlt
Loading required package: basefun
Loading required package: variables
Loading required package: tram
Loading required package: mvtnorm
Loading required package: trtf
Loading required package: partykit
Loading required package: grid

Attaching package: ‘grid’

The following object is masked from ‘package:variables’:

    unit

Loading required package: libcoin
Loading required package: SparseGrid
Loading required package: ATR
Loading required package: tramME
Loading required package: multcomp
Loading required package: survival
Loading required package: TH.data
Loading required package: MASS

Attaching package: ‘TH.data’

The following object is masked from ‘package:MASS’:

    geyser

Loading required package: coin

Attaching package: ‘coin’

The following object is masked from ‘package:variables’:

    support

Loading required package: colorspace
Loading required package: xtable
Loading required package: english

> if (any(!pkgs)) {
+     cat(paste("Package(s)", paste(names(pkgs)[!pkgs], collapse = ", "), 
+         "not available, stop processing.", "\\end{doc ..." ... [TRUNCATED] 

> if (!interactive() && .Platform$OS.type != "unix") {
+     cat(paste("Vignette only compiled under Unix alikes.", "\\end{document}\n"))
+     knitr: .... [TRUNCATED] 

> set.seed(290875)

> xlab <- "Time (in days)"

> lxlab <- paste0(xlab, " on log-scale")

> ylabS <- "Probability of survival"

> ylablHaz <- "Log-cumulative hazard"

> ylabcumHR <- expression(Lambda[1](t)/Lambda[0](t))

> ylimS <- c(0, 1)

> ylimHR <- c(0, 1.6)

> q <- 0:2204

> xlim <- c(0, max(q))

> lwd <- 1.3

> acol <- sequential_hcl(6, "BluYl")[1:5]

> col <- acol[c(2, (length(acol)) - 1)]

> lcol <- lighten(col, amount = 0.4)

> perm_test_biv.stram <- function(object, seed = 1) {
+     stopifnot(inherits(object, "stram"))
+     fixed <- c(trt = 0, scl = 0)
+     lhs <- objec .... [TRUNCATED] 

> big.mark <- "'"

> frmt0 <- round

> frmt <- function(digits, x, math = FALSE) {
+     if (!is.numeric(x)) 
+         return(x)
+     ret <- formatC(round(x, digits), digits = digits, f .... [TRUNCATED] 

> frmt1 <- function(x, math = FALSE) frmt(1, x = x, 
+     math = math)

> frmt2 <- function(x, math = FALSE) frmt(2, x = x, 
+     math = math)

> frmt3 <- function(x, math = FALSE) frmt(3, x = x, 
+     math = math)

> frmtll <- function(x, math = FALSE, mark = FALSE) {
+     if (!inherits(x, "logLik") && !is.numeric(x) && all(!is.na(x))) 
+         x <- logLik(x)
 .... [TRUNCATED] 

> load(system.file("rda", "Primary_endpoint_data.rda", 
+     package = "TH.data"))

> levs <- levels(CAOsurv$randarm)

> trt <- with(CAOsurv, paste0("randarm", levs[2], collapse = ""))

> nd1 <- data.frame(randarm = factor(levs, levels = levs))

> CAOsurv$strat <- with(CAOsurv, interaction(strat_t, 
+     strat_n))

> slevs <- levels(CAOsurv$strat)

> nd2 <- data.frame(randarm = nd1$randarm[1], strat = factor(slevs, 
+     levels = slevs))

> lslevs <- gsub("\\.", " : ", slevs)

> lslevs <- gsub("cT4", "cT4    ", lslevs)

> CAOsurv$id <- factor(1:nrow(CAOsurv))

> library("knitr")

> knitr::opts_chunk$set(results = "hide", echo = FALSE, 
+     purl = TRUE, tidy = FALSE, size = "small", error = FALSE, 
+     warning = FALSE, messa .... [TRUNCATED] 

> opts_knit$set(global.par = TRUE)

> knitr::render_sweave()

> knitr::set_header(highlight = "")

> options(prompt = "R> ", continue = "+  ", useFancyQuotes = FALSE)

> options(width = 75, digits = 4)

> frmtI <- function(x, math = FALSE) {
+     if (is.character(x)) 
+         return(x)
+     ret <- trimws(formatC(x, format = "fg", width = 7, big.ma .... [TRUNCATED] 

> frmtN <- function(x, bound = 10, all = TRUE) {
+     ret <- round(x)
+     if (all | x <= bound) 
+         return(as.character(english::english(ret .... [TRUNCATED] 

> frmtd <- function(date) format(date, format = "%b~%-d")

> frmtD <- function(date) format(date, format = "%B~%-d")

> toUpper <- function(x) gsub("\\b([[:lower:]])([[:lower:]]+)", 
+     "\\U\\1\\L\\2", x, perl = TRUE)

> frmtp <- function(pv) paste("$p$ =", frmt3(pv))

> frmtCI <- function(x, phantom = FALSE, math = FALSE) {
+     if (!isTRUE(nrow(x) > 1)) 
+         phantom <- FALSE
+     if (phantom) 
+         pha .... [TRUNCATED] 

> ret.tram <- function(object, seed = 25, math = TRUE) {
+     mod0 <- object
+     if (inherits(object, "Survreg")) 
+         object <- as.mlt(objec .... [TRUNCATED] 

> print.tram <- function(object) {
+     ret <- ret.tram(object)
+     cat("\\begin{center}")
+     cat("\n")
+     cat("\n")
+     print(xtable(ret,  .... [TRUNCATED] 

> is.neg <- function(x) x < 0

> lHR <- function(model, frmt = function(x) {
+     frmt3(x, math = FALSE)
+ }) {
+     stopifnot(inherits(model, c("tram", "mlt", "tramME")))
+     c .... [TRUNCATED] 

> HR <- function(model, frmt = function(x) {
+     frmt3(x, math = FALSE)
+ }) frmt(exp(lHR(model, frmt = function(x) {
+     x
+ })))

> par_main <- expression(par(mgp = c(2.5, 1, 0), mar = c(4, 
+     4, 1.5, 4), las = 1))

> par_surv <- expression(par(mgp = c(2.5, 1, 0), mar = c(6, 
+     6, 0.5, 4), las = 1))

> library("tram")

> risktab <- function(ti, st) {
+     nrisk <- NULL
+     for (t in ti) nrisk <- c(nrisk, sum(st >= t))
+     return(nrisk)
+ }

> plot.risktab <- function(tvar, ti = seq(min(q), max(q), 
+     by = 500), cex = 0.8, at = -450) {
+     mtext(levs[1], 1, line = 4, at = at, cex = c .... [TRUNCATED] 

> surv_OS <- survfit(OS ~ randarm, data = CAOsurv)

> surv_iDFS <- survfit(iDFS ~ randarm, data = CAOsurv)

> tab <- xtabs(~strat + randarm, data = CAOsurv)

> tab <- rbind(tab, Total = colSums(tab))

> eval(par_surv)

> plot(surv_iDFS, ylim = ylimS, xlim = xlim, col = lcol, 
+     lwd = lwd, xlab = xlab, ylab = ylabS)

> legend("bottomright", legend = levs, col = col, bty = "n", 
+     lty = 1, lwd = 1, cex = 0.8)

> plot.risktab(tvar = "iDFStime")

> plot(surv_OS, ylim = ylimS, xlim = xlim, col = lcol, 
+     lwd = lwd, xlab = xlab, ylab = ylabS)

> legend("bottomright", legend = levs, col = col, bty = "n", 
+     lty = 1, lwd = 1, cex = 0.8)

> plot.risktab(tvar = "OStime")

> mw <- Survreg(iDFS ~ randarm, data = CAOsurv, dist = "weibull")

> summary(mw)

  Weibull Linear Regression Model 

Call:
Survreg(formula = iDFS ~ randarm, data = CAOsurv, dist = "weibull")

Coefficients:
                          Estimate Std. Error z value Pr(>|z|)  
randarm5-FU + Oxaliplatin    0.229      0.106    2.15    0.032 *
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Log-Likelihood:
 -2281 (df = 3)
Likelihood-ratio Test: Chisq = 4.652 on 1 degrees of freedom; p = 0.031


> coef(mw, as.survreg = TRUE)
              (Intercept) randarm5-FU + Oxaliplatin 
                   8.5021                    0.3124 
attr(,"scale")
log(iDFS) 
    1.364 

> score_test(mw)

	Transformation Score Test

data:  Survreg(formula = iDFS ~ randarm, data = CAOsurv, dist = "weibull")
Z = -2.2, p-value = 0.03
alternative hypothesis: true  for randarm5-FU + Oxaliplatin is not equal to 0
95 percent confidence interval:
 0.02063 0.43733
sample estimates:
 for randarm5-FU + Oxaliplatin 
                         0.229 


> perm_test(mw)

	Asymptotic Permutation Transformation Score Test

data:  Survreg(formula = iDFS ~ randarm, data = CAOsurv, dist = "weibull")
Z = -2.1, p-value = 0.03
alternative hypothesis: true  for randarm5-FU + Oxaliplatin is not equal to 0
95 percent confidence interval:
 0.01606 0.44170
sample estimates:
 for randarm5-FU + Oxaliplatin 
                         0.229 


> mc <- Coxph(iDFS ~ randarm, data = CAOsurv)

> summary(mc)

  Parametric Linear Cox Regression Model 

Call:
Coxph(formula = iDFS ~ randarm, data = CAOsurv)

Coefficients:
                          Estimate Std. Error z value Pr(>|z|)  
randarm5-FU + Oxaliplatin   -0.231      0.107   -2.17     0.03 *
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Log-Likelihood:
 -2242 (df = 8)
Likelihood-ratio Test: Chisq = 4.718 on 1 degrees of freedom; p = 0.0299


> score_test(mc)

	Transformation Score Test

data:  Coxph(formula = iDFS ~ randarm, data = CAOsurv)
Z = 2.2, p-value = 0.03
alternative hypothesis: true log-hazard ratio for randarm5-FU + Oxaliplatin is not equal to 0
95 percent confidence interval:
 -0.43898 -0.02224
sample estimates:
log-hazard ratio for randarm5-FU + Oxaliplatin 
                                       -0.2306 


> perm_test(mc)

	Asymptotic Permutation Transformation Score Test

data:  Coxph(formula = iDFS ~ randarm, data = CAOsurv)
Z = 2.2, p-value = 0.03
alternative hypothesis: true log-hazard ratio for randarm5-FU + Oxaliplatin is not equal to 0
95 percent confidence interval:
 -0.43901 -0.02206
sample estimates:
log-hazard ratio for randarm5-FU + Oxaliplatin 
                                       -0.2306 


> cb <- confband(as.mlt(mc), newdata = nd1[1, , drop = FALSE], 
+     K = 20, cheat = 100)

> eval(par_main)

> cb <- cb[cb[, "q"] > 0, ]

> plot(cb[, "q"], cb[, "Estimate"], log = "x", type = "n", 
+     xlab = lxlab, ylab = ylablHaz, xlim = xlimlHaz <- range(cb[, 
+         "q"]), ylim  .... [TRUNCATED] 

> polygon(c(cb[, "q"], rev(cb[, "q"])), c(cb[, "lwr"], 
+     rev(cb[, "upr"])), border = NA, col = rgb(0.1, 0.1, 0.1, 
+     0.1))

> lines(cb[, "q"], cb[, "Estimate"], lwd = lwd)

> fastopt <- mltoptim(abstol = 0.001, reltol = 0.001)

> fastoptH <- mltoptim(abstol = 0.001, reltol = 0.001, 
+     hessian = TRUE)

> mcst <- Coxph(iDFS | strat ~ randarm, data = CAOsurv, 
+     optim = fastopt)

> summary(mcst)

 (Stratified) Parametric Linear Cox Regression Model 

Call:
Coxph(formula = iDFS | strat ~ randarm, data = CAOsurv, optim = fastopt)

Coefficients:
                          Estimate Std. Error z value Pr(>|z|)  
randarm5-FU + Oxaliplatin   -0.228      0.107   -2.13    0.033 *
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Log-Likelihood:
 -2214 (df = 29)
Likelihood-ratio Test: Chisq = 4.669 on 1 degrees of freedom; p = 0.0307


> score_test(mcst)

	Transformation Score Test

data:  Coxph(formula = iDFS | strat ~ randarm, data = CAOsurv, optim = fastopt)
Z = 2.1, p-value = 0.03
alternative hypothesis: true log-hazard ratio for randarm5-FU + Oxaliplatin is not equal to 0
95 percent confidence interval:
 -0.43553 -0.01964
sample estimates:
log-hazard ratio for randarm5-FU + Oxaliplatin 
                                       -0.2275 


> perm_test(mcst)

	Asymptotic Permutation Transformation Score Test

data:  Coxph(formula = iDFS | strat ~ randarm, data = CAOsurv, optim = fastopt)
Z = 2.1, p-value = 0.03
alternative hypothesis: true log-hazard ratio for randarm5-FU + Oxaliplatin is not equal to 0
95 percent confidence interval:
 -0.43696 -0.01836
sample estimates:
log-hazard ratio for randarm5-FU + Oxaliplatin 
                                       -0.2275 


> plot(as.mlt(mcst), newdata = nd2, q = q[q > 0], type = "logcumhazard", 
+     log = "x", lty = lty <- 1:4, xlab = lxlab, ylab = ylablHaz, 
+     xli .... [TRUNCATED] 

> legend("bottomright", legend = lslevs, title = "Stratum", 
+     lty = lty, lwd = lwd, col = 1, bty = "n")

> mcs <- Coxph(iDFS ~ randarm | randarm, data = CAOsurv)

> summary(mcs)

  Shift-Scale Transformation Model 

Call:
Coxph(formula = iDFS ~ randarm | randarm, data = CAOsurv)

Coefficients:
                              Estimate Std. Error z value Pr(>|z|)
randarm5-FU + Oxaliplatin      -0.0909     0.1632   -0.56     0.58
scl_randarm5-FU + Oxaliplatin   0.2567     0.2026    1.27     0.21

Log-Likelihood:
 -2241 (df = 9)
Likelihood-ratio Test: Chisq = 6.311 on 2 degrees of freedom; p = 0.0426


> confint(mcs)
                                2.5 % 97.5 %
randarm5-FU + Oxaliplatin     -0.4108 0.2290
scl_randarm5-FU + Oxaliplatin -0.1404 0.6538

> perm_test_biv.stram(mcs)
[1] 0.02733
99 percent confidence interval:
 0.02733 0.02733 


> eval(par_surv)

> plot(surv_iDFS, ylim = ylimS, xlim = xlim, col = lcol, 
+     lwd = lwd, xlab = xlab, ylab = ylabS)

> legend("bottomright", legend = levs, col = col, bty = "n", 
+     lty = 1, lwd = 1, cex = 0.8)

> plot.risktab(tvar = "iDFStime")

> plot(as.mlt(mcs), type = "survivor", newdata = nd1, 
+     col = col, add = TRUE)

> qHR <- seq(50, max(q), by = 1)

> cumhaz <- predict(mcs, type = "cumhazard", newdata = nd1, 
+     q = qHR)

> cumhr <- unname(cumhaz[, 2]/cumhaz[, 1])

> plot(qHR, cumhr, type = "l", ylab = ylabcumHR, xlab = xlab, 
+     ylim = ylimHR, xlim = xlimHR <- range(qHR), lwd = lwd)

> abline(h = exp(coef(mc)), lty = 2, lwd = 1)

> abline(h = 1, lty = 3)

> mcv <- Coxph(iDFS | randarm ~ 1, data = CAOsurv)

> logLik(mcv)
'log Lik.' -2240 (df=14)

> mcv <- as.mlt(mcv)

> s <- mkgrid(mcv, 39)

> s$iDFS <- s$iDFS[s$iDFS >= min(xlimHR) & s$iDFS <= 
+     max(xlimHR)]

> nd3 <- expand.grid(s)

> K <- model.matrix(mcv$model, data = nd3)

> Kyes <- K[nd3$randarm == levels(nd3$randarm)[2], ]

> Kyes[, grep("Intercept", colnames(Kyes))] <- 0

> gh <- glht(parm(coef(mcv), vcov(mcv)), Kyes)

> ci <- exp(confint(gh)$confint)

> coxy <- s$iDFS

> ci2 <- exp(confint(mc))

> plot(coxy, ci[, "Estimate"], ylim = ylimHR, type = "n", 
+     xlim = xlimHR, xlab = xlab, ylab = ylabcumHR)

> polygon(c(coxy, rev(coxy)), c(ci[, "lwr"], rev(ci[, 
+     "upr"])), border = NA, col = rgb(0.1, 0.1, 0.1, 0.1))

> lines(coxy, ci[, "Estimate"], lty = 1, lwd = lwd)

> polygon(c(coxy[c(1, length(coxy))], rev(coxy[c(1, 
+     length(coxy))])), rep(ci2, c(2, 2)), border = NA, col = rgb(0.1, 
+     0.1, 0.1, 0.1))

> abline(h = exp(coef(mc)), lty = 2, lwd = 1)

> abline(h = 1, lty = 3)

> patnr_lofu <- c(1012, 2003, 3002, 3003, 6018, 7001, 
+     7003, 7005, 7008, 7012, 10003, 10012, 11018, 12003, 12014, 
+     13028, 14002, 15001, 16 .... [TRUNCATED] 

> ilofu <- with(CAOsurv, which(patnr %in% patnr_lofu))

> CAOsurv$DepCevent <- CAOsurv$OSevent

> CAOsurv$DepCevent <- factor(as.numeric(CAOsurv$DepCevent), 
+     levels = 0:2, labels = c("AdminC", "EoI", "DepC"))

> CAOsurv$DepCevent[ilofu] <- "DepC"

> CAOsurv$nDepCevent <- factor(as.character(CAOsurv$DepCevent), 
+     levels = c("AdminC", "EoI", "DepC"), labels = c("Administrative censoring", 
+  .... [TRUNCATED] 

> tab <- xtabs(~nDepCevent + randarm, data = CAOsurv)

> tab
                          randarm
nDepCevent                 5-FU 5-FU + Oxaliplatin
  Administrative censoring  469                466
  Event of interest         106                 96
  Loss of follow-up          48                 51

> md <- Coxph(Surv(OStime, event = DepCevent) ~ randarm, 
+     data = CAOsurv, optim = fastoptH)

> summary(md)

 

Call:
Coxph(formula = Surv(OStime, event = DepCevent) ~ randarm, data = CAOsurv, 
    optim = fastoptH)

Coefficients:
                                                Estimate Std. Error
Event_EoI.Event_EoI.Bs1(Event_EoI)               -7.2632     0.7793
Event_EoI.Event_EoI.Bs2(Event_EoI)               -4.9711     1.3128
Event_EoI.Event_EoI.Bs3(Event_EoI)               -0.8871     2.1362
Event_EoI.Event_EoI.Bs4(Event_EoI)                0.2202     2.0206
Event_EoI.Event_EoI.Bs5(Event_EoI)                0.2203     0.8634
Event_EoI.Event_EoI.Bs6(Event_EoI)                0.2202     0.8634
Event_EoI.Event_EoI.Bs7(Event_EoI)                0.8778     0.6249
Event_EoI.Event_EoI.randarm5-FU + Oxaliplatin    -0.0319     0.1428
Event_DepC.Event_DepC.(Intercept)               -12.1857     0.9744
Event_DepC.Event_DepC.log(Event_DepC)             1.3351     0.1403
Event_DepC.Event_DepC.randarm5-FU + Oxaliplatin  -0.1113     0.2027
Event_DepC.Event_EoI.(Intercept)                  0.0215     0.4545
                                                z value Pr(>|z|)    
Event_EoI.Event_EoI.Bs1(Event_EoI)                -9.32  < 2e-16 ***
Event_EoI.Event_EoI.Bs2(Event_EoI)                -3.79  0.00015 ***
Event_EoI.Event_EoI.Bs3(Event_EoI)                -0.42  0.67795    
Event_EoI.Event_EoI.Bs4(Event_EoI)                 0.11  0.91323    
Event_EoI.Event_EoI.Bs5(Event_EoI)                 0.26  0.79856    
Event_EoI.Event_EoI.Bs6(Event_EoI)                 0.26  0.79870    
Event_EoI.Event_EoI.Bs7(Event_EoI)                 1.40  0.16009    
Event_EoI.Event_EoI.randarm5-FU + Oxaliplatin     -0.22  0.82315    
Event_DepC.Event_DepC.(Intercept)                -12.51  < 2e-16 ***
Event_DepC.Event_DepC.log(Event_DepC)              9.51  < 2e-16 ***
Event_DepC.Event_DepC.randarm5-FU + Oxaliplatin   -0.55  0.58297    
Event_DepC.Event_EoI.(Intercept)                   0.05  0.96229    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Log-Likelihood:
 -3062 (df = 12)


> confint(md)
                                                   2.5 %   97.5 %
Event_EoI.Event_EoI.Bs1(Event_EoI)               -8.7906  -5.7358
Event_EoI.Event_EoI.Bs2(Event_EoI)               -7.5441  -2.3981
Event_EoI.Event_EoI.Bs3(Event_EoI)               -5.0739   3.2998
Event_EoI.Event_EoI.Bs4(Event_EoI)               -3.7401   4.1804
Event_EoI.Event_EoI.Bs5(Event_EoI)               -1.4719   1.9126
Event_EoI.Event_EoI.Bs6(Event_EoI)               -1.4720   1.9123
Event_EoI.Event_EoI.Bs7(Event_EoI)               -0.3469   2.1025
Event_EoI.Event_EoI.randarm5-FU + Oxaliplatin    -0.3118   0.2480
Event_DepC.Event_DepC.(Intercept)               -14.0955 -10.2759
Event_DepC.Event_DepC.log(Event_DepC)             1.0600   1.6102
Event_DepC.Event_DepC.randarm5-FU + Oxaliplatin  -0.5085   0.2859
Event_DepC.Event_EoI.(Intercept)                 -0.8693   0.9123

> library("tramME")

> mcME <- CoxphME(iDFS ~ randarm + (1 | Block), data = CAOsurv)

> summary(mcME)

Mixed-Effects Parametric Cox Regression Model

	Formula:
iDFS ~ randarm + (1 | Block)

	Fitted to dataset CAOsurv  

	Fixed effects parameters:
	=========================

                          Estimate Std. Error z value Pr(>|z|)  
randarm5-FU + Oxaliplatin   -0.235      0.107    -2.2    0.028 *
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

	Random effects:
	===============

Grouping factor: Block (362 levels)
Standard deviation:
(Intercept) 
      0.267 


	Log-likelihood: -2242 (npar = 9)


> confint(mcME)
                               lwr      upr
Bs1(iDFS)                 -11.1737 -5.90492
Bs2(iDFS)                  -9.5287 -3.37428
Bs3(iDFS)                  -6.5397  1.18025
Bs4(iDFS)                  -5.0906 -0.26878
Bs5(iDFS)                  -3.6187 -1.74067
Bs6(iDFS)                  -1.1281 -0.69005
Bs7(iDFS)                  -0.9479 -0.63975
randarm5-FU + Oxaliplatin  -0.4452 -0.02565
Block|(Intercept)          -2.6956  0.05330

> tmp <- CAOsurv$iDFS

> exact <- tmp[, 3] == 1

> tmp[exact, 2] <- tmp[exact, 1] + 2

> tmp[exact, 1] <- pmax(tmp[exact, 1] - 2, 0)

> tmp[exact, 3] <- 3

> CAOsurv$iDFS2 <- tmp

> mmc <- mtram(Coxph(iDFS2 ~ randarm, data = CAOsurv), 
+     formula = ~(1 | Block), data = CAOsurv, optim = fastoptH)

> mHR.mtram <- function(object, with_confint = FALSE, 
+     seed = 1) {
+     stopifnot(inherits(object, "mtram"))
+     cf <- coef(object)
+     cf  .... [TRUNCATED] 

> coef(mmc)
               Bs1(iDFS2)                Bs2(iDFS2) 
                  -8.4299                   -6.1272 
               Bs3(iDFS2)                Bs4(iDFS2) 
                  -2.7133                   -2.7137 
               Bs5(iDFS2)                Bs6(iDFS2) 
                  -2.1821                   -0.9164 
               Bs7(iDFS2) randarm5-FU + Oxaliplatin 
                  -0.8015                   -0.2349 
                   gamma1 
                   0.1822 

> sqrt(diag(vcov(mmc)))
               Bs1(iDFS2)                Bs2(iDFS2) 
                   1.2586                    0.8595 
               Bs3(iDFS2)                Bs4(iDFS2) 
                   0.3029                    0.3029 
               Bs5(iDFS2)                Bs6(iDFS2) 
                   0.2898                    0.1038 
               Bs7(iDFS2) randarm5-FU + Oxaliplatin 
                   0.0762                    0.1074 
                   gamma1 
                   0.1170 

> (ci_MCOX <- mHR.mtram(mmc, with_confint = TRUE))
     randarm5-FU + Oxaliplatin   2.5%  97.5%
[1,]                    0.7937 0.6466 0.9785

> ma <- CoxphME(iDFS ~ randarm + s(age, by = as.ordered(randarm), 
+     fx = TRUE, k = 6), data = CAOsurv)

> nd <- model.frame(ma)[rep(2, 100), ]

> nd$age <- seq(min(CAOsurv$age), max(CAOsurv$age), 
+     length.out = 100)

> xx <- model.matrix(ma, data = nd, type = "X", keep_sign = FALSE)$X

> ip <- grep("randarm", names(bb <- coef(ma, with_baseline = TRUE)))

> vc <- vcov(ma, parm = names(bb)[ip])

> bb <- bb[ip]

> cb <- exp(confint(multcomp::glht(multcomp::parm(bb, 
+     vc), linfct = xx), calpha = univariate_calpha())$confint)

> summary(ma)

Additive Parametric Cox Regression Model

	Formula:
iDFS ~ randarm + s(age, by = as.ordered(randarm), fx = TRUE, 
    k = 6)

	Fitted to dataset CAOsurv  

	Fixed effects parameters:
	=========================

                          Estimate Std. Error z value Pr(>|z|)  
randarm5-FU + Oxaliplatin   -0.246      0.107   -2.29    0.022 *
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

	Smooth shift terms:
	===================

                                             edf
s(age):as.ordered(randarm)5-FU + Oxaliplatin   5

	Log-likelihood: -2238 (npar = 13)


> plot(nd$age, cb[, "Estimate"], type = "n", ylab = "Hazard ratio", 
+     xlab = "Age (in years)", ylim = ylimHR)

> polygon(c(nd$age, rev(nd$age)), c(cb[, "lwr"], rev(cb[, 
+     "upr"])), border = NA, col = rgb(0.1, 0.1, 0.1, 0.1))

> lines(nd$age, cb[, "Estimate"], lwd = lwd)

> abline(h = 1, lty = 3)

> rug(CAOsurv$age, lwd = 2, col = rgb(0.1, 0.1, 0.1, 
+     0.1))

> library("trtf")

> set.seed(4)

> tr <- trafotree(Coxph(iDFS ~ randarm, data = CAOsurv), 
+     formula = iDFS ~ randarm | age, data = CAOsurv, control = ctree_control(teststat = "ma ..." ... [TRUNCATED] 
Warning in doTest(lev, teststat = teststat, pvalue = pvalue, lower = TRUE,  :
  cmvnorm: completion with ERROR > EPS
Warning in doTest(lev, teststat = teststat, pvalue = pvalue, lower = TRUE,  :
  cmvnorm: completion with ERROR > EPS

> logLik(tr)
'log Lik.' -2236 (df=16)

> library("ATR")

> plot(rotate(tr), tp_args = list(newdata = nd1, type = "survivor", 
+     col = col, lwd = lwd), terminal_panel = trtf:::node_mlt)

> mf <- Coxph(iDFS ~ randarm, data = CAOsurv, frailty = "Gamma")

> logLik(mf)
'log Lik.' -2242 (df=8)

> coef(mf)[trt]
randarm5-FU + Oxaliplatin 
                  -0.3013 

> coef(mf, addparm = TRUE)
logrho 
0.1599 

> confint(mf, parm = c(trt, "logrho"))
                            2.5 % 97.5 %
randarm5-FU + Oxaliplatin -0.8055 0.2028
logrho                         NA     NA

> ml <- Colr(iDFS ~ randarm, data = CAOsurv)

> m <- as.mlt(Survreg(OS ~ randarm + age, data = CAOsurv, 
+     dist = "weibull", support = c(0.1, 80 * 365)))

> N <- 500

> nd <- with(CAOsurv, data.frame(randarm = gl(2, N, 
+     labels = levels(randarm)), age = rnorm(N, mean = mean(age), 
+     sd = sd(age))))

> `coef<-` <- mlt::`coef<-`

> cf <- coef(m)

> cf["randarm5-FU + Oxaliplatin"] <- 0.25

> coef(m) <- cf

> nd$T <- as.Surv(simulate(m, newdata = nd, K = 1000))

> cf["(Intercept)"] <- cf["(Intercept)"] + qlogis(0.8)

> coef(m) <- cf

> nd$C <- as.Surv(simulate(m, newdata = nd, K = 1000))

> nd$nOS <- with(nd, Surv(time = pmin(T[, "time"], C[, 
+     "time"]), event = T[, "time"] < C[, "time"]))

 *** Run successfully completed ***
> proc.time()
   user  system elapsed 
 73.044   0.251  73.317 
